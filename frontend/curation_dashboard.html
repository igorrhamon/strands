<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strands SRE Curation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app" class="container mx-auto p-6">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">üõ°Ô∏è Strands Curation Dashboard</h1>
                <p class="text-gray-600">Review and approve AI-generated remediation playbooks</p>
            </div>
            <div class="flex gap-4">
                <div class="bg-white p-3 rounded shadow">
                    <span class="block text-xs text-gray-500">Pending Review</span>
                    <span class="text-xl font-bold text-orange-500">{{ pendingCount }}</span>
                </div>
                <div class="bg-white p-3 rounded shadow">
                    <span class="block text-xs text-gray-500">Approved Today</span>
                    <span class="text-xl font-bold text-green-500">{{ approvedCount }}</span>
                </div>
            </div>
        </header>

        <main>
            <div v-if="loading" class="text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-4 text-gray-500">Loading playbooks...</p>
            </div>

            <div v-else-if="playbooks.length === 0" class="text-center py-12 bg-white rounded shadow">
                <p class="text-xl text-gray-500">üéâ No pending playbooks to review!</p>
            </div>

            <div v-else class="grid gap-6">
                <div v-for="playbook in playbooks" :key="playbook.playbook_id" class="bg-white rounded-lg shadow-md overflow-hidden border-l-4 border-orange-400">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="inline-block px-2 py-1 text-xs font-semibold bg-orange-100 text-orange-800 rounded mb-2">
                                    {{ playbook.pattern_type }}
                                </span>
                                <h2 class="text-xl font-bold text-gray-800">{{ playbook.title }}</h2>
                                <p class="text-sm text-gray-500">Service: <span class="font-mono">{{ playbook.service_name }}</span></p>
                            </div>
                            <div class="text-right">
                                <span class="block text-xs text-gray-500">Risk Level</span>
                                <span :class="{'text-red-600': playbook.risk_level === 'HIGH', 'text-yellow-600': playbook.risk_level === 'MEDIUM'}" class="font-bold">
                                    {{ playbook.risk_level }}
                                </span>
                            </div>
                        </div>

                        <p class="text-gray-700 mb-4">{{ playbook.description }}</p>

                        <div class="bg-gray-50 p-4 rounded mb-4">
                            <h3 class="font-semibold text-gray-700 mb-2">Execution Steps:</h3>
                            <ol class="list-decimal list-inside space-y-2">
                                <li v-for="step in playbook.steps" :key="step.step" class="text-sm text-gray-600">
                                    <span class="font-medium">{{ step.title }}</span>: {{ step.description }}
                                    <div v-if="step.commands && step.commands.length" class="mt-1 ml-4 bg-gray-800 text-green-400 p-2 rounded font-mono text-xs">
                                        <div v-for="cmd in step.commands">{{ cmd }}</div>
                                    </div>
                                </li>
                            </ol>
                        </div>

                        <div class="flex justify-between items-center border-t pt-4 mt-4">
                            <div class="text-xs text-gray-500">
                                Generated by: {{ playbook.source }} ‚Ä¢ {{ formatDate(playbook.created_at) }}
                            </div>
                            <div class="flex gap-3">
                                <button @click="rejectPlaybook(playbook)" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded transition">
                                    Reject
                                </button>
                                <button @click="approvePlaybook(playbook)" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition shadow">
                                    Approve & Activate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Approve Modal -->
        <div v-if="showApproveModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-bold mb-4">Approve Playbook</h3>
                <p class="text-sm text-gray-600 mb-4">You are about to activate this playbook for production use.</p>
                <textarea v-model="approvalNotes" placeholder="Add approval notes (optional)..." class="w-full border rounded p-2 mb-4 h-24"></textarea>
                <div class="flex justify-end gap-2">
                    <button @click="showApproveModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button @click="confirmApprove" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Confirm Approval</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    playbooks: [],
                    loading: true,
                    pendingCount: 0,
                    approvedCount: 0,
                    showApproveModal: false,
                    selectedPlaybook: null,
                    approvalNotes: ''
                }
            },
            mounted() {
                this.fetchPlaybooks()
            },
            methods: {
                async fetchPlaybooks() {
                    this.loading = true
                    try {
                        // Mock API call - replace with actual endpoint
                        // const response = await axios.get('/api/playbooks/pending')
                        // this.playbooks = response.data
                        
                        // Mock data for demonstration
                        await new Promise(r => setTimeout(r, 800))
                        this.playbooks = [
                            {
                                playbook_id: "pb-123",
                                title: "Remediate High CPU in API Service",
                                description: "Scales up the service when CPU usage exceeds 90% for 5 minutes.",
                                pattern_type: "METRIC_METRIC",
                                service_name: "api-service",
                                risk_level: "MEDIUM",
                                source: "LLM_GENERATED",
                                created_at: new Date().toISOString(),
                                steps: [
                                    { step: 1, title: "Check Metrics", description: "Verify CPU usage via kubectl top", commands: ["kubectl top pod -l app=api-service"] },
                                    { step: 2, title: "Scale Up", description: "Increase replicas to 5", commands: ["kubectl scale deployment api-service --replicas=5"] }
                                ]
                            },
                            {
                                playbook_id: "pb-456",
                                title: "Restart Worker on Memory Leak",
                                description: "Restarts worker pods when memory usage shows leak pattern.",
                                pattern_type: "LOG_METRIC",
                                service_name: "worker-service",
                                risk_level: "HIGH",
                                source: "LLM_GENERATED",
                                created_at: new Date().toISOString(),
                                steps: [
                                    { step: 1, title: "Check Logs", description: "Look for OOM errors", commands: ["kubectl logs -l app=worker-service --tail=100 | grep OOM"] },
                                    { step: 2, title: "Restart Rollout", description: "Trigger rolling restart", commands: ["kubectl rollout restart deployment worker-service"] }
                                ]
                            }
                        ]
                        this.pendingCount = this.playbooks.length
                    } catch (error) {
                        console.error("Error fetching playbooks:", error)
                    } finally {
                        this.loading = false
                    }
                },
                formatDate(dateString) {
                    return new Date(dateString).toLocaleString()
                },
                approvePlaybook(playbook) {
                    this.selectedPlaybook = playbook
                    this.showApproveModal = true
                },
                async confirmApprove() {
                    if (!this.selectedPlaybook) return
                    
                    try {
                        // await axios.post(`/api/playbooks/${this.selectedPlaybook.playbook_id}/approve`, {
                        //     approved_by: "sre-user",
                        //     notes: this.approvalNotes
                        // })
                        
                        // Remove from list
                        this.playbooks = this.playbooks.filter(p => p.playbook_id !== this.selectedPlaybook.playbook_id)
                        this.approvedCount++
                        this.pendingCount--
                        this.showApproveModal = false
                        this.approvalNotes = ''
                        this.selectedPlaybook = null
                    } catch (error) {
                        console.error("Error approving playbook:", error)
                    }
                },
                rejectPlaybook(playbook) {
                    if (confirm("Are you sure you want to reject this playbook?")) {
                        this.playbooks = this.playbooks.filter(p => p.playbook_id !== playbook.playbook_id)
                        this.pendingCount--
                    }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
